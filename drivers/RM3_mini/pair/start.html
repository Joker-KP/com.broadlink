<script>
  var ExpectedDeviceID = 10039;  // RM3-mini
</script>


<style type="text/css">
  span label {
    width: 100px
  }
  p {text-align:center}
  table,td {width:100% ; height:100%}
</style>


<style type="text/css">
    .broadlink-pairing {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    .broadlink-pairing {
        width: 100%;
    }
    .buttons, .messages {
        padding-top: 14px;
    }
	.doorbird-status {
		display: none;
		align: left;
	}
</style>


<p data-i18n="pair.intro"></p>
    <div class="broadlink-pairing">
<table>
<TR><TD>
        <div class="form-group">
            <label for="address" data-i18n="pair.address"></label>
            <input type="text" class="form-control" id="address" placeholder="0.0.0.0">
        </div>
</td></TR><tr><td>
        <div class="messages">
            <p class="broadlink-status broadlink-error" style="color: #ff6300;"><span class="broadlink-error-msg"></span></p>
        </div>
</td></TR><tr><td>
        <div class="form-group buttons">
	        <table><TR>
	           <TD align="left"><button id="add" onclick="add()" class="button" data-i18n="pair.add"></button>
	           <TD align="right"><button id="cancel" onclick="cancel()" class="button" data-i18n="pair.cancel"></button>
            </TR></table>
        </div>
</table>
</div>

<script type="text/javascript">





function showError( msg ) {
	$('.broadlink-error').show();
    $('.broadlink-error-msg').html( msg );
}

function add( data ) {

	var ipAddressElement = document.getElementById('address');
    var device = { 
			address: ipAddressElement.value.trim()
	}
    if( device.address ) {
        var m = device.address.match(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g);
    	if( ( ! m ) || ( m.length != 1 ) ) {
    		showError(Homey.__('pair.invalid_ipaddress'))
    	}
    	else {
    		showError( Homey.__('pair.discovering') );
    		Homey.emit('start_discover', device, null )    		
    	}
    }
    else {
    	showError(Homey.__('pair.invalid_ipaddress'))
    }
}




Homey.on('discovered', function (device) {

	if( device ) {
		showError( "found " + device.data.devtype);
		
		if( parseInt(device.data.devtype) == ExpectedDeviceID ) {
			showError( `found correct device: ${device.data.name} (${device.data.devtype})`);
			Homey.showView('list_devices');
		}
		else {
			showError( Homey.__('pair.found_another') + device.data.name + '(' + device.data.devtype + ')');
		}
	}
	else {
		showError( Homey.__('pair.error_no_discover') );
	}

})



// function called when user pressed button
function cancel(data) {
	Homey.done();
}




</script>

