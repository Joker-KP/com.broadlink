<!--
 * Driver for Broadlink devices
 *
 * Copyright 2018, R Wensveen
 *
 * This file is part of com.broadlink
 * com.broadlink is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * com.broadlink is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with com.broadlink.  If not, see http://www.gnu.org/licenses/.
-->

<style type="text/css">
  span label {
    width: 100px
  }
  p {text-align:center}
  table,td {width:100% ; height:100%}
</style>


<style type="text/css">
    .broadlink-pairing {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        width: 100%;
    }
    .buttons, .messages {
        padding-top: 14px;
    }
</style>


<p data-i18n="pair.intro"></p>
    <div class="broadlink-pairing">
<table>
<TR><TD>
        <div class="form-group">
            <label for="address" data-i18n="pair.address"></label>
            <input type="text" class="form-control" id="address" placeholder="0.0.0.0">
        </div>
</td></TR><tr><td>
        <div class="messages">
            <p id="broadlink-error" style="color: #ff6300;"> </p>
        </div>
</td></TR><tr><td>
        <div class="form-group buttons">
	        <table><TR>
	           <TD align="left"><button  id="add"    onclick="add()"    class="button" data-i18n="pair.add"></button>
	           <TD align="right"><button id="cancel" onclick="cancel()" class="button" data-i18n="pair.cancel"></button>
            </TR></table>
        </div>
</table>
</div>

<script type="text/javascript">

Homey.setTitle(Homey.__('pair.title'));


function showError( msg ) {
 	//document.getElementById('broadlink-error').style.display = "none";
	document.getElementById('broadlink-error').innerHTML = msg;
}


function add( data ) {

	var ipAddressElement = document.getElementById('address');
    var device = {
			address: ipAddressElement.value.trim()
	}
    if( device.address ) {
        var m = device.address.match(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g);
    	if( ( ! m ) || ( m.length != 1 ) ) {
    		showError(Homey.__('pair.invalid_ipaddress'))
    	}
    	else {
    		showError( Homey.__('pair.discovering') );
    		Homey.emit('start_discover', device, null )    
    	}
    }
    else {
    	showError(Homey.__('pair.invalid_ipaddress'))
    }
}


//function called when user pressed button
function cancel(data) {
	Homey.emit('disconnect');
	Homey.done();
}


Homey.on('discovered', function ( deviceData ) {

	if( deviceData ) {
		if( deviceData.isCompatible ) {
			Homey.showView('list_devices');
		}
		else {
			showError( Homey.__('pair.found_another', {'dev': deviceData.device.data.name,
														'type': deviceData.device.data.devtype.toString('hex') }));
		}
	}
	else {
		showError( Homey.__('pair.error_no_discover') );
	}
})



</script>

